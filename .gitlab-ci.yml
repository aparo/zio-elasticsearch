image: "aparo/sbt-nodejs-docker:1.3.4-12.13.1"

# variables:
#   SBT_OPTS: "-Dsbt.global.base=sbt-cache/sbtboot -Dsbt.boot.directory=sbt-cache/boot -Dsbt.ivy.home=sbt-cache/ivy"
#   COURSIER_CACHE: sbt-cache/coursier #only needed if you use coursier


# cache:
#   # if you want to have a separate cache per branch, uncomment the next line
#   # key: "$CI_BUILD_REF_NAME"
#   untracked: true
#   paths:
#     - "sbt-cache/ivy/cache"
#     - "sbt-cache/boot"
#     - "sbt-cache/sbtboot"
#     - "sbt-cache/target"
#     - "sbt-cache/coursier" #only needed if you use coursier

stages:
  - publish
  - pages

allinone:
  stage: publish
  before_script:
    - cat $CREDENTIALS_SBT > credentials.sbt
    - git config --global user.name $GIT_ACCESS_USER
    - git config --global user.email $GIT_ACCESS_EMAIL
    - git reset --hard
    - git clean -fd
    - git checkout $CI_COMMIT_REF_NAME
    - git pull origin $CI_COMMIT_REF_NAME
    - git remote set-url origin https://${$GIT_ACCESS_USER}:${GIT_ACCESS_TOKEN}@gitlab.megl.io/$CI_PROJECT_PATH.git



  script:
#    - sbt clean test publish
    - sbt "release with-defaults"

pages:
  stage: pages
  script:
    - sbt clean coverage test coverageReport coverageOff doc
    - cp -r target/scala-2.13/scoverage-report public/scoverage-report
    - cp -r target/scala-2.13/api public/api
  artifacts:
    paths:
      - public
